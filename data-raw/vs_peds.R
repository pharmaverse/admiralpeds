# Dataset: vs_ped
# Description: VS test SDTM dataset for pediatric studies

# Load libraries -----
library(pharmaversesdtm) # TODO remove when this script is moved to pharmaversesdtm
library(dplyr)
library(purrr)

## Read input data ----
data("vs")

## Create anthropometric data for pediatric patients
vs_peds <- tibble::tribble(
  ~USUBJID, ~VISIT, ~VISITNUM, ~VSTESTCD, ~VSDTC, ~VSSTRESN,
  "PEDS-1001", "SCREENING", 1, "WEIGHT", "2022-10-11", 4.4946,
  "PEDS-1001", "SCREENING", 1, "HEIGHT", "2022-10-11", 54.8012,
  "PEDS-1001", "SCREENING", 1, "BMI", "2022-10-11", 14.966178,
  "PEDS-1001", "SCREENING", 1, "HDCIRC", "2022-10-11", 37.3172,
  "PEDS-1001", "DAY 1", 2, "WEIGHT", "2022-10-21", 4.76286,
  "PEDS-1001", "DAY 1", 2, "HEIGHT", "2022-10-21", 56.1104,
  "PEDS-1001", "DAY 1", 2, "BMI", "2022-10-21", 15.127985,
  "PEDS-1001", "DAY 1", 2, "HDCIRC", "2022-10-21", 37.9978,
  "PEDS-1001", "6 MONTHS", 3, "WEIGHT", "2023-04-21", 8.18724,
  "PEDS-1001", "6 MONTHS", 3, "HEIGHT", "2023-04-21", 69.6421,
  "PEDS-1001", "6 MONTHS", 3, "BMI", "2023-04-21", 16.88083,
  "PEDS-1001", "6 MONTHS", 3, "HDCIRC", "2023-04-21", 44.1698,
  "PEDS-1001", "12 MONTHS", 4, "WEIGHT", "2023-10-21", 6.301,
  "PEDS-1001", "12 MONTHS", 4, "HEIGHT", "2023-10-21", 77.306,
  "PEDS-1001", "12 MONTHS", 4, "BMI", "2023-10-21", 10.543458,
  "PEDS-1001", "12 MONTHS", 4, "HDCIRC", "2023-10-21", 46.4254,
  "PEDS-1002", "SCREENING", 1, "WEIGHT", "2022-09-23", 6.1202,
  "PEDS-1002", "SCREENING", 1, "HEIGHT", "2022-09-23", 60.80944,
  "PEDS-1002", "SCREENING", 1, "BMI", "2022-09-23", 16.550976,
  "PEDS-1002", "SCREENING", 1, "HDCIRC", "2022-09-23", 39.9658,
  "PEDS-1002", "DAY 1", 2, "WEIGHT", "2022-10-03", 6.42981,
  "PEDS-1002", "DAY 1", 2, "HEIGHT", "2022-10-03", 61.54576,
  "PEDS-1002", "DAY 1", 2, "BMI", "2022-10-03", 16.97469,
  "PEDS-1002", "DAY 1", 2, "HDCIRC", "2022-10-03", 40.30284,
  "PEDS-1002", "6 MONTHS", 3, "WEIGHT", "2023-04-03", 8.66424,
  "PEDS-1002", "6 MONTHS", 3, "HEIGHT", "2023-04-03", 71.0932,
  "PEDS-1002", "6 MONTHS", 3, "BMI", "2023-04-03", 17.142507,
  "PEDS-1002", "6 MONTHS", 3, "HDCIRC", "2023-04-03", 44.07858,
  "PEDS-1002", "12 MONTHS", 4, "WEIGHT", "2023-10-03", 16.168,
  "PEDS-1002", "12 MONTHS", 4, "HEIGHT", "2023-10-03", 77.23,
  "PEDS-1002", "12 MONTHS", 4, "BMI", "2023-10-03", 27.10717,
  "PEDS-1002", "12 MONTHS", 4, "HDCIRC", "2023-10-03", 40.318,
  "PEDS-1003", "SCREENING", 1, "WEIGHT", "2023-01-19", 7.4198,
  "PEDS-1003", "SCREENING", 1, "HEIGHT", "2023-01-19", 66.2745,
  "PEDS-1003", "SCREENING", 1, "BMI", "2023-01-19", 16.892708,
  "PEDS-1003", "SCREENING", 1, "HDCIRC", "2023-01-19", 42.4255,
  "PEDS-1003", "DAY 1", 2, "WEIGHT", "2023-01-29", 7.41117,
  "PEDS-1003", "DAY 1", 2, "HEIGHT", "2023-01-29", 66.785,
  "PEDS-1003", "DAY 1", 2, "BMI", "2023-01-29", 16.616093,
  "PEDS-1003", "DAY 1", 2, "HDCIRC", "2023-01-29", 42.6319,
  "PEDS-1003", "6 MONTHS", 3, "WEIGHT", "2023-07-30", 8.84714,
  "PEDS-1003", "6 MONTHS", 3, "HEIGHT", "2023-07-30", 74.7998,
  "PEDS-1003", "6 MONTHS", 3, "BMI", "2023-07-30", 15.812554,
  "PEDS-1003", "6 MONTHS", 3, "HDCIRC", "2023-07-30", 45.0808,
  "PEDS-1003", "12 MONTHS", 4, "WEIGHT", "2024-01-29", 11.412,
  "PEDS-1003", "12 MONTHS", 4, "HEIGHT", "2024-01-29", 81.3788,
  "PEDS-1003", "12 MONTHS", 4, "BMI", "2024-01-29", 17.232139,
  "PEDS-1003", "12 MONTHS", 4, "HDCIRC", "2024-01-29", 46.3576,
  "PEDS-1005", "SCREENING", 1, "WEIGHT", "2021-07-20", 5.134555,
  "PEDS-1005", "SCREENING", 1, "HEIGHT", "2021-07-20", 55.397317,
  "PEDS-1005", "SCREENING", 1, "BMI", "2021-07-20", 16.73113,
  "PEDS-1005", "SCREENING", 1, "HDCIRC", "2021-07-20", NA,
  "PEDS-1005", "DAY 1", 2, "WEIGHT", "2021-07-30", 5.626815,
  "PEDS-1005", "DAY 1", 2, "HEIGHT", "2021-07-30", 55.397317,
  "PEDS-1005", "DAY 1", 2, "BMI", "2021-07-30", 18.33518,
  "PEDS-1005", "DAY 1", 2, "HDCIRC", "2021-07-30", NA,
  "PEDS-1005", "6 MONTHS", 3, "WEIGHT", "2022-01-28", 7.817525,
  "PEDS-1005", "6 MONTHS", 3, "HEIGHT", "2022-01-28", 68.333417,
  "PEDS-1005", "6 MONTHS", 3, "BMI", "2022-01-28", 16.741833,
  "PEDS-1005", "6 MONTHS", 3, "HDCIRC", "2022-01-28", NA,
  "PEDS-1005", "12 MONTHS", 4, "WEIGHT", "2022-07-30", 9.655419,
  "PEDS-1005", "12 MONTHS", 4, "HEIGHT", "2022-07-30", 82.213357,
  "PEDS-1005", "12 MONTHS", 4, "BMI", "2022-07-30", 14.285201,
  "PEDS-1005", "12 MONTHS", 4, "HDCIRC", "2022-07-30", NA,
  "PEDS-1006", "SCREENING", 1, "WEIGHT", "2023-08-22", 12.134555,
  "PEDS-1006", "SCREENING", 1, "HEIGHT", "2023-08-22", 85.315597,
  "PEDS-1006", "SCREENING", 1, "BMI", "2023-08-22", 16.671205,
  "PEDS-1006", "SCREENING", 1, "HDCIRC", "2023-08-22", NA,
  "PEDS-1006", "DAY 1", 2, "WEIGHT", "2023-09-01", 12.842296,
  "PEDS-1006", "DAY 1", 2, "HEIGHT", "2023-09-01", 85.315597,
  "PEDS-1006", "DAY 1", 2, "BMI", "2023-09-01", 17.64355,
  "PEDS-1006", "DAY 1", 2, "HDCIRC", "2023-09-01", NA,
  "PEDS-1006", "6 MONTHS", 3, "WEIGHT", "2024-03-01", 14.269619,
  "PEDS-1006", "6 MONTHS", 3, "HEIGHT", "2024-03-01", 90.24991,
  "PEDS-1006", "6 MONTHS", 3, "BMI", "2024-03-01", 17.51938,
  "PEDS-1006", "6 MONTHS", 3, "HDCIRC", "2024-03-01", NA,
  "PEDS-1006", "12 MONTHS", 4, "WEIGHT", "2024-08-31", 17.362444,
  "PEDS-1006", "12 MONTHS", 4, "HEIGHT", "2024-08-31", 98.805282,
  "PEDS-1006", "12 MONTHS", 4, "BMI", "2024-08-31", 17.78486,
  "PEDS-1006", "12 MONTHS", 4, "HDCIRC", "2024-08-31", NA,
  "PEDS-1010", "SCREENING", 1, "WEIGHT", "2021-07-20", 8.881023,
  "PEDS-1010", "SCREENING", 1, "HEIGHT", "2021-07-20", 57.571318,
  "PEDS-1010", "SCREENING", 1, "BMI", "2021-07-20", 26.79481,
  "PEDS-1010", "SCREENING", 1, "HDCIRC", "2021-07-20", NA,
  "PEDS-1010", "DAY 1", 2, "WEIGHT", "2021-07-30", 8.989297,
  "PEDS-1010", "DAY 1", 2, "HEIGHT", "2021-07-30", 59.571318,
  "PEDS-1010", "DAY 1", 2, "BMI", "2021-07-30", 25.33094,
  "PEDS-1010", "DAY 1", 2, "HDCIRC", "2021-07-30", NA,
  "PEDS-1010", "6 MONTHS", 3, "WEIGHT", "2022-01-28", 10.916794,
  "PEDS-1010", "6 MONTHS", 3, "HEIGHT", "2022-01-28", 71.939372,
  "PEDS-1010", "6 MONTHS", 3, "BMI", "2022-01-28", 21.09414,
  "PEDS-1010", "6 MONTHS", 3, "HDCIRC", "2022-01-28", NA,
  "PEDS-1010", "12 MONTHS", 4, "WEIGHT", "2022-07-30", 17.719649,
  "PEDS-1010", "12 MONTHS", 4, "HEIGHT", "2022-07-30", 80.773011,
  "PEDS-1010", "12 MONTHS", 4, "BMI", "2022-07-30", 27.15955,
  "PEDS-1010", "12 MONTHS", 4, "HDCIRC", "2022-07-30", NA,
  "PEDS-1012", "SCREENING", 1, "WEIGHT", "2023-07-04", 6.355839,
  "PEDS-1012", "SCREENING", 1, "HEIGHT", "2023-07-04", 59.838861,
  "PEDS-1012", "SCREENING", 1, "BMI", "2023-07-04", 17.75032,
  "PEDS-1012", "SCREENING", 1, "HDCIRC", "2023-07-04", NA,
  "PEDS-1012", "DAY 1", 2, "WEIGHT", "2023-07-14", 6.70235,
  "PEDS-1012", "DAY 1", 2, "HEIGHT", "2023-07-14", 61.366952,
  "PEDS-1012", "DAY 1", 2, "BMI", "2023-07-14", 17.79746,
  "PEDS-1012", "DAY 1", 2, "HDCIRC", "2023-07-14", NA,
  "PEDS-1012", "6 MONTHS", 3, "WEIGHT", "2024-01-12", 8.08854,
  "PEDS-1012", "6 MONTHS", 3, "HEIGHT", "2024-01-12", 68.499468,
  "PEDS-1012", "6 MONTHS", 3, "BMI", "2024-01-12", 17.23835,
  "PEDS-1012", "6 MONTHS", 3, "HDCIRC", "2024-01-12", NA,
  "PEDS-1012", "12 MONTHS", 4, "WEIGHT", "2024-07-13", 13.133554,
  "PEDS-1012", "12 MONTHS", 4, "HEIGHT", "2024-07-13", 78.452126,
  "PEDS-1012", "12 MONTHS", 4, "BMI", "2024-07-13", 21.33894,
  "PEDS-1012", "12 MONTHS", 4, "HDCIRC", "2024-07-13", NA,
  "PEDS-1013", "SCREENING", 1, "WEIGHT", "2024-01-21", 4.82798,
  "PEDS-1013", "SCREENING", 1, "HEIGHT", "2024-01-21", 58.486564,
  "PEDS-1013", "SCREENING", 1, "BMI", "2024-01-21", 14.11410,
  "PEDS-1013", "SCREENING", 1, "HDCIRC", "2024-01-21", NA,
  "PEDS-1013", "DAY 1", 2, "WEIGHT", "2024-01-31", 4.625681,
  "PEDS-1013", "DAY 1", 2, "HEIGHT", "2024-01-31", 59.486564,
  "PEDS-1013", "DAY 1", 2, "BMI", "2024-01-31", 13.07188,
  "PEDS-1013", "DAY 1", 2, "HDCIRC", "2024-01-31", NA,
  "PEDS-1013", "6 MONTHS", 3, "WEIGHT", "2024-07-31", 7.565278,
  "PEDS-1013", "6 MONTHS", 3, "HEIGHT", "2024-07-31", 64.755501,
  "PEDS-1013", "6 MONTHS", 3, "BMI", "2024-07-31", 18.04145,
  "PEDS-1013", "6 MONTHS", 3, "HDCIRC", "2024-07-31", NA,
  "PEDS-1013", "12 MONTHS", 4, "WEIGHT", "2025-01-30", 10.607152,
  "PEDS-1013", "12 MONTHS", 4, "HEIGHT", "2025-01-30", 77.3437,
  "PEDS-1013", "12 MONTHS", 4, "BMI", "2025-01-30", 17.73164,
  "PEDS-1013", "12 MONTHS", 4, "HDCIRC", "2025-01-30", NA,
  "PEDS-1009", "SCREENING", 1, "WEIGHT", "2024-01-23", 5.642814,
  "PEDS-1009", "SCREENING", 1, "HEIGHT", "2024-01-23", 56.277578,
  "PEDS-1009", "SCREENING", 1, "BMI", "2024-01-23", 17.81660,
  "PEDS-1009", "SCREENING", 1, "HDCIRC", "2024-01-23", NA,
  "PEDS-1009", "6 MONTHS", 3, "WEIGHT", "2024-07-02", 8.651415,
  "PEDS-1009", "6 MONTHS", 3, "HEIGHT", "2024-07-02", 67.320201,
  "PEDS-1009", "6 MONTHS", 3, "BMI", "2024-02-07", 19.08958,
  "PEDS-1009", "6 MONTHS", 3, "HDCIRC", "2024-07-02", NA,
  "PEDS-1009", "12 MONTHS", 4, "WEIGHT", "2024-12-02", 12,
  "PEDS-1009", "12 MONTHS", 4, "HEIGHT", "2024-12-02", 88,
  "PEDS-1009", "12 MONTHS", 4, "BMI", "2024-02-12", 15.49587,
  "PEDS-1009", "12 MONTHS", 4, "HDCIRC", "2024-12-02", NA
) %>%
  mutate(
    STUDYID = "PEDS SAMPLE STUDY",
    DOMAIN = "VS",
    VSSEQ = row_number(),
    VSPOS = NA_character_,
    VSORRESU = case_when(
      VSTESTCD == "HEIGHT" ~ "cm",
      VSTESTCD == "WEIGHT" ~ "kg",
      VSTESTCD == "BMI" ~ "kg/m2",
      VSTESTCD == "HDCIRC" ~ "cm",
      TRUE ~ NA_character_
    ),
    VSTEST = case_when(
      VSTESTCD == "HEIGHT" ~ "Height",
      VSTESTCD == "WEIGHT" ~ "Weight",
      VSTESTCD == "BMI" ~ "BMI",
      VSTESTCD == "HDCIRC" ~ "Head Circumference",
      TRUE ~ NA_character_
    ),
    VSSTRESC = as.character(VSSTRESN),
    VSORRES = VSSTRESC,
    VSSTRESU = VSORRESU,
    VSSTAT = NA_character_,
    VSLOC = NA_character_,
    VSBLFL = if_else(VISITNUM == 2, "Y", NA_character_),
    VISITDY = NA_integer_,
    VSDY = NA_integer_,
    VSEVAL = NA_character_,
    EPOCH = "Epoch"
  ) %>%
  select(
    STUDYID, DOMAIN, USUBJID, VSSEQ, VSTESTCD, VSTEST,
    VSORRES, VSORRESU, VSSTRESC, VSSTRESN, VSSTRESU, VSEVAL,
    EPOCH, VISIT, VISITNUM, VSDTC, VSDY
  )

# get common column names with VS
common_cols <- seq_along(intersect(names(vs_peds), names(vs)))
# Apply label
lapply(common_cols, function(x) {
  attr(vs_peds[[common_cols[x]]], "label") <- attr(vs[[common_cols[x]]], "label")
})

# Label dataset ----
attr(vs_peds, "label") <- "Vital Signs"

# Save dataset ----
usethis::use_data(vs_peds, overwrite = TRUE)
